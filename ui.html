<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Voice Assistant</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
        }
        
        /* Custom Scrollbar */ 
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; 
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; 
        }

        /* Microphone Pulse Animation */
        .mic-active {
            animation: pulse-ring 2s infinite;
            background-color: #ef4444 !important; /* Red-500 */
        }
        
        @keyframes pulse-ring {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* Chat Bubble Animations */
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-message {
            animation: fade-in-up 0.3s ease-out forwards;
        }

        .user-bubble {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            border-radius: 18px 18px 0 18px;
        }
        .ai-bubble {
            background: #374151; /* Gray-700 */
            border-radius: 18px 18px 18px 0;
            border: 1px solid #4b5563;
        }
    </style>
</head>
<body class="text-white min-h-screen flex items-center justify-center p-4">

    <!-- Main Container Card -->
    <div id="app" class="w-full max-w-md bg-gray-800/90 backdrop-blur-sm rounded-3xl shadow-2xl border border-gray-700 overflow-hidden flex flex-col h-[85vh]">
        
        <!-- Header -->
        <div class="bg-gray-900/50 p-6 border-b border-gray-700 flex flex-col items-center">
            <div class="w-12 h-12 rounded-full bg-indigo-500/20 flex items-center justify-center mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                </svg>
            </div>
            <h1 class="text-xl font-bold text-white tracking-tight">Gemini Assistant</h1>
            <div class="flex items-center gap-2 mt-2">
                <span class="relative flex h-2 w-2">
                  <span id="status-dot" class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75 hidden"></span>
                  <span id="status-dot-static" class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                </span>
                <span id="status-message" class="text-xs font-medium text-gray-400 uppercase tracking-wider">Ready</span>
            </div>
        </div>

        <!-- Chat Area -->
        <div id="conversation-log" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-900/30">
            <!-- Welcome Message -->
            <div class="flex flex-col items-center justify-center h-full text-center text-gray-500 space-y-2 opacity-60" id="empty-state">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                </svg>
                <p class="text-sm">Tap the microphone to start talking</p>
            </div>
        </div>

        <!-- Footer / Controls -->
        <div class="p-6 bg-gray-900/80 border-t border-gray-700 backdrop-blur-md">
            <div class="flex flex-col items-center justify-center space-y-4">
                
                <!-- Main Mic Button -->
                <button id="main-toggle-btn" 
                        class="group relative w-20 h-20 rounded-full bg-gray-700 hover:bg-gray-600 transition-all duration-300 shadow-xl flex items-center justify-center border-4 border-gray-800 focus:outline-none"
                        onclick="toggleConversation()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white transition-transform group-hover:scale-110" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                    </svg>
                </button>
                
                <p class="text-xs text-gray-500 font-medium">Click to Speak</p>
            </div>
        </div>

        <!-- Emergency Support Banner (Compact) -->
        <div class="px-4 py-2 bg-red-900/20 border-t border-red-900/30">
            <div class="flex justify-between items-center text-xs">
                <span class="text-red-300 font-medium">Emergency Support?</span>
                <a href="tel:+912227546669" class="text-red-400 hover:text-red-300 font-bold transition-colors">Call Helpline</a>
            </div>
        </div>

        <!-- Custom Modal -->
        <div id="modal-container" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
            <div class="bg-gray-800 p-6 rounded-2xl shadow-2xl max-w-sm w-full border border-gray-700 transform transition-all scale-100">
                <div class="w-10 h-10 rounded-full bg-red-500/20 flex items-center justify-center mb-4 mx-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <h3 class="text-lg font-bold text-center text-white mb-2">Connection Issue</h3>
                <p id="modal-message" class="text-gray-400 text-sm text-center mb-6 leading-relaxed"></p>
                <button onclick="document.getElementById('modal-container').classList.add('hidden')" 
                        class="w-full bg-gray-700 hover:bg-gray-600 text-white font-medium py-2.5 px-4 rounded-xl transition duration-200">
                    Dismiss
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // Change this if your backend is running on a different port (e.g., 8001)
        const API_ENDPOINT = "http://127.0.0.1:8080/chat"; 
        
        const MAX_RETRIES = 3;
        const INITIAL_BACKOFF_MS = 1000;
        
        // --- DOM Elements ---
        const conversationLog = document.getElementById('conversation-log');
        const mainToggleBtn = document.getElementById('main-toggle-btn');
        const statusMessageEl = document.getElementById('status-message');
        const statusDot = document.getElementById('status-dot');
        const statusDotStatic = document.getElementById('status-dot-static');
        const modalContainer = document.getElementById('modal-container');
        const emptyState = document.getElementById('empty-state');
        
        // --- State ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const synth = window.speechSynthesis;
        let recognition = null;
        let isConversationActive = false;
        let sweetVoice = null; 

        // --- Utility ---
        function showModal(message) {
            document.getElementById('modal-message').innerHTML = message.replace(/\n/g, '<br>');
            modalContainer.classList.remove('hidden');
            modalContainer.classList.add('flex');
        }

        function updateUI(status, isRecording = false) {
            statusMessageEl.textContent = status;
            
            if (isRecording) {
                mainToggleBtn.classList.add('mic-active');
                statusDot.classList.remove('hidden');
                statusDotStatic.classList.replace('bg-emerald-500', 'bg-red-500');
            } else {
                mainToggleBtn.classList.remove('mic-active');
                statusDot.classList.add('hidden');
                
                if (status === "Processing...") {
                    statusDotStatic.classList.replace('bg-red-500', 'bg-yellow-500');
                    statusDotStatic.classList.replace('bg-emerald-500', 'bg-yellow-500');
                } else if (status === "Speaking...") {
                    statusDotStatic.classList.replace('bg-yellow-500', 'bg-indigo-500');
                } else {
                    statusDotStatic.className = 'relative inline-flex rounded-full h-2 w-2 bg-emerald-500'; // Reset to ready
                }
            }
        }

        function appendMessage(role, text) {
            if (emptyState) emptyState.style.display = 'none';

            const isUser = role === 'user';
            const bubbleClass = isUser ? 'user-bubble' : 'ai-bubble';
            const alignClass = isUser ? 'items-end' : 'items-start';
            const label = isUser ? 'You' : 'Gemini';

            const wrapper = document.createElement('div');
            wrapper.className = flex flex-col ${alignClass} chat-message;

            const bubble = document.createElement('div');
            bubble.className = max-w-[85%] p-3.5 text-sm leading-relaxed text-white shadow-md ${bubbleClass};
            bubble.innerHTML = text;

            const caption = document.createElement('span');
            caption.className = "text-[10px] text-gray-500 mt-1 px-1";
            caption.textContent = label;

            wrapper.appendChild(bubble);
            wrapper.appendChild(caption);
            
            conversationLog.appendChild(wrapper);
            conversationLog.scrollTop = conversationLog.scrollHeight;
        }

        // --- Voice Logic ---
        function selectSweetVoice() {
            const voices = synth.getVoices();
            const preferredNames = ["Google US English", "Samantha", "Zoe", "Karen", "Serena", "Tess"];
            for (const name of preferredNames) {
                sweetVoice = voices.find(voice => voice.name.includes(name) && voice.lang.startsWith('en'));
                if (sweetVoice) return;
            }
            sweetVoice = voices.find(voice => voice.lang.startsWith('en'));
        }
        
        if (synth && synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = selectSweetVoice;
        }

        function speakAndResume(text) {
            if (!text || !synth) {
                appendMessage('ai', text + ' (TTS unavailable)');
                startRecognition(); 
                return;
            }

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US'; 
            if (sweetVoice) utterance.voice = sweetVoice;
            
            utterance.onstart = () => updateUI('Speaking...', false);
            utterance.onend = () => {
                if (isConversationActive) {
                    updateUI('Listening...', true);
                    startRecognition(); 
                } else {
                    updateUI('Ready', false);
                }
            };
            utterance.onerror = (e) => {
                console.error("TTS Error:", e);
                startRecognition();
            };

            synth.speak(utterance);
        }

        async function processQuery(query) {
            if (recognition) recognition.abort(); 
            appendMessage('user', query);
            updateUI('Processing...', false);

            try {
                for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
                    try {
                        const response = await fetch(API_ENDPOINT, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ prompt: query }),
                        });

                        if (!response.ok) throw new Error(HTTP ${response.status});
                        
                        const data = await response.json();
                        if (data.error) throw new Error(data.error); 
                        
                        appendMessage('ai', data.response);
                        speakAndResume(data.response);
                        return;

                    } catch (error) {
                        if (attempt === MAX_RETRIES - 1) throw error;
                        await new Promise(r => setTimeout(r, INITIAL_BACKOFF_MS * Math.pow(2, attempt)));
                    }
                }
            } catch (error) {
                console.error('API Error:', error);
                const msg = Failed to connect to backend (${API_ENDPOINT}).\n\n1. Run 'uvicorn main:app --port 8080 --reload'\n2. Open this HTML file locally.;
                updateUI('Error', false);
                showModal(msg);
                isConversationActive = false;
            }
        }

        // --- Speech Recognition ---
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
            
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript.trim();
                if (transcript) processQuery(transcript);
            };

            recognition.onerror = (event) => {
                if (event.error === 'aborted') return;
                console.error('Mic Error:', event.error);
                if (isConversationActive) {
                    // Simple retry for no-speech or network bumps
                    if (event.error === 'no-speech' || event.error === 'network') {
                        updateUI('Listening...', true);
                        try { recognition.start(); } catch(e){}
                    } else {
                        isConversationActive = false;
                        updateUI('Error', false);
                    }
                }
            };

            recognition.onend = () => {
                // Auto-restart if active and not speaking
                if (isConversationActive && !synth.speaking && statusMessageEl.textContent === 'Listening...') {
                    try { recognition.start(); } catch(e){}
                }
            };
            
            recognition.onstart = () => updateUI('Listening...', true);
        } else {
            showModal("Web Speech API not supported in this browser.");
        }

        function startRecognition() {
            if (isConversationActive && recognition) {
                try { recognition.start(); } catch (e) {}
            }
        }

        function toggleConversation() {
            if (isConversationActive) {
                isConversationActive = false;
                if (recognition) recognition.abort(); 
                if (synth.speaking) synth.cancel(); 
                updateUI('Ready', false);
            } else {
                isConversationActive = true;
                conversationLog.innerHTML = ''; 
                emptyState.style.display = 'flex'; // Reset view
                
                // Kickoff
                speakAndResume("Hello! I am Gemini. How can I help?");
            }
        }

        window.onload = () => {
             updateUI('Ready', false);
             selectSweetVoice();
        };
    </script>
</body>
</html>
